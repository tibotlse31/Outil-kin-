<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Outil Gyroscopique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
    }
    .big-angle {
      font-size: 6rem;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-gray-900 via-gray-800 to-gray-900 text-white flex flex-col items-center justify-start min-h-screen p-6 space-y-8">
  <h1 class="text-4xl font-bold text-center drop-shadow-lg">üéµ Outil Gyroscopique Multi-Plages</h1>

  <div class="bg-slate-800 rounded-2xl px-8 py-6 shadow-2xl ring-1 ring-slate-600">
    <div id="angleDisplay" class="big-angle text-white text-center">0.0¬∞</div>
  </div>

  <div id="freqDisplay" class="text-base text-gray-400 italic">Fr√©quence : 0 Hz</div>

  <div class="w-full max-w-md bg-slate-800 p-4 rounded-xl shadow-md">
    <div id="rangeList" class="space-y-4"></div>
    <button id="addRangeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl mt-4 transition-all duration-200">‚ûï Ajouter une plage</button>
  </div>

  <div class="flex gap-4 mt-6 flex-wrap justify-center">
    <button id="startButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-xl shadow-md transition-all">‚ñ∂Ô∏è D√©marrer outil</button>
    <button id="stopButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-xl shadow-md transition-all">‚èπÔ∏è Stop</button>
    <button id="recordButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-xl shadow-md transition-all">üî¥ Enregistrer GO/STOP</button>
  </div>

  <script>
    let audioCtx, oscillator, gainNode;
    let running = false;
    let recording = false;
    let angleLog = [];

    const angleDisplay = document.getElementById("angleDisplay");
    const freqDisplay = document.getElementById("freqDisplay");
    const rangeList = document.getElementById("rangeList");

    function createRangeRow(min = 0, max = 30) {
      const wrapper = document.createElement("div");
      wrapper.className = "flex items-center gap-2";

      wrapper.innerHTML = `
        <label class="text-sm">Min: <input type="number" step="0.1" value="${min}" class="minAngle w-20 px-2 py-1 rounded text-black"></label>
        <label class="text-sm">Max: <input type="number" step="0.1" value="${max}" class="maxAngle w-20 px-2 py-1 rounded text-black"></label>
        <button class="removeBtn bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">‚úñ</button>
      `;

      wrapper.querySelector(".removeBtn").addEventListener("click", () => wrapper.remove());
      rangeList.appendChild(wrapper);
    }

    document.getElementById("addRangeBtn").addEventListener("click", () => createRangeRow());

    function getDefinedRanges() {
      const rows = rangeList.querySelectorAll(".flex");
      return Array.from(rows).map(row => {
        const min = parseFloat(row.querySelector(".minAngle").value);
        const max = parseFloat(row.querySelector(".maxAngle").value);
        return { min, max };
      });
    }

    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      oscillator = audioCtx.createOscillator();
      gainNode = audioCtx.createGain();
      gainNode.gain.value = 0;

      oscillator.type = 'sine';
      oscillator.connect(gainNode).connect(audioCtx.destination);
      oscillator.start();
    }

    function handleOrientation(event) {
      const beta = parseFloat(event.beta.toFixed(2));
      angleDisplay.textContent = `${beta}¬∞`;

      if (recording) {
        const timestamp = Date.now();
        angleLog.push({ time: timestamp, angle: beta });
      }

      const ranges = getDefinedRanges();
      let maxVolume = 0;

      for (const range of ranges) {
        if ((range.min < range.max && beta >= range.min && beta <= range.max) ||
            (range.max < range.min && beta <= range.min && beta >= range.max)) {
          const norm = Math.abs((beta - range.min) / (range.max - range.min));
          maxVolume = Math.max(maxVolume, Math.min(1, norm));
        }
      }

      const frequency = 200 + maxVolume * 1000;
      if (oscillator && gainNode) {
        oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        gainNode.gain.setTargetAtTime(maxVolume, audioCtx.currentTime, 0.05);
      }

      freqDisplay.textContent = `Fr√©quence : ${maxVolume > 0 ? frequency.toFixed(0) : 0} Hz`;
    }

    document.getElementById("startButton").addEventListener("click", async () => {
      if (running) return;
      if (typeof DeviceOrientationEvent?.requestPermission === 'function') {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission !== "granted") return alert("Permission refus√©e");
      }

      initAudio();
      window.addEventListener("deviceorientation", handleOrientation);
      running = true;
    });

    document.getElementById("stopButton").addEventListener("click", () => {
      if (!running) return;
      window.removeEventListener("deviceorientation", handleOrientation);
      if (gainNode) gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
      running = false;
      if (recording) {
        exportData();
        recording = false;
      }
    });

    document.getElementById("recordButton").addEventListener("click", () => {
      if (!running) return alert("L'outil doit d'abord √™tre d√©marr√©.");

      if (!recording) {
        angleLog = [];
        recording = true;
        alert("Enregistrement en cours...");
      } else {
        recording = false;
        exportData();
      }
    });

    function exportData() {
      if (angleLog.length === 0) return alert("Aucune donn√©e enregistr√©e.");

      let csvContent = "data:text/csv;charset=utf-8,Time (ms),Angle\n" +
        angleLog.map(e => `${e.time},${e.angle}`).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "angle_data.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    createRangeRow(20, 40);
  </script>
</body>
</html>

